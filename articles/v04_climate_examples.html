<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Extracting Weather/Climate Geospatial Data with `chopin` • chopin</title>
<!-- rOpenSci favicons --><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="/apple-touch-icon.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><script src="../deps/MathJax-3.2.2/tex-chtml.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Extracting Weather/Climate Geospatial Data with `chopin`">
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/orestbida/cookieconsent@v3.0.0/dist/cookieconsent.css">
<script src="https://cdn.jsdelivr.net/gh/orestbida/cookieconsent@v3.0.0/dist/cookieconsent.umd.js" data-cfasync="false"></script><script src="https://ropensci.org/scripts/matomo.js"></script><noscript><p><img src="https://ropensci.matomo.cloud/matomo.php?idsite=1&amp;rec=1" style="border:0;" alt=""></p></noscript>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">
    <a href="https://ropensci.org" class="external-link"><img src="https://ropensci.org/img/icon_short_white.svg" id="hexlogo" alt="rOpenSci"></a>
    <a class="navbar-brand me-2" href="../index.html">chopin</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.9.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/v01_start.html">Getting started with chopin</a></li>
    <li><a class="dropdown-item" href="../articles/v02_good_practice.html">Good practice of using `chopin`</a></li>
    <li><a class="dropdown-item" href="../articles/v03_par_pad_grid.html">Generate computational grids</a></li>
    <li><a class="dropdown-item" href="../articles/v04_climate_examples.html">Extracting Weather/Climate Geospatial Data with `chopin`</a></li>
    <li><a class="dropdown-item" href="../articles/v05_targets.html">targets and grid objects</a></li>
  </ul>
</li>
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ropensci/chopin/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Extracting Weather/Climate Geospatial Data with `chopin`</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ropensci/chopin/blob/master/vignettes/v04_climate_examples.Rmd" class="external-link"><code>vignettes/v04_climate_examples.Rmd</code></a></small>
      <div class="d-none name"><code>v04_climate_examples.Rmd</code></div>
    </div>

    
    
<!-- header change
---
title: "Extracting Weather/Climate Geospatial Data with `chopin`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Extracting Weather/Climate Geospatial Data with `chopin`}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
-->
<!--
knitr::knit("tools/vignettes-sources/v02_climate_example.Rmd", "tools/vignettes-sources/v02_climate_example_knit.Rmd")
-->
<!--
quarto callout-notes
::: {.callout-note}
Note that there are five types of callouts, including:
`note`, `warning`, `important`, `tip`, and `caution`.
:::
-->
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This document demonstrates to parallelize weather/climate geospatial
data processing with <code>chopin</code> and what cases users may take
advantage of parallel processing or not. We will cover the following
formats:</p>
<p>We consider TerraClimate and PRISM data which have its own data
format each. <a href="https://prism.oregonstate.edu" class="external-link">Parameter-elevation
Regressions on Independent Slopes Model (PRISM)</a> is a high-resolution
(800-1,000 meters) gridded climate dataset available in the BIL (band
interleaved by line) format which is readable with GDAL. TerraClimate is
a high-resolution (5 km) gridded climate dataset in the NetCDF format
which is readable with GDAL.</p>
<table class="table">
<colgroup>
<col width="20%">
<col width="36%">
<col width="23%">
<col width="19%">
</colgroup>
<thead><tr class="header">
<th align="center">Data</th>
<th align="left">Source</th>
<th align="left">Resolution</th>
<th align="left">File format</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">TerraClimate</td>
<td align="left">University of Idaho</td>
<td align="left">0.0417 degrees</td>
<td align="left">NetCDF</td>
</tr>
<tr class="even">
<td align="center">PRISM</td>
<td align="left">Oregon State University</td>
<td align="left">0.0083 degrees</td>
<td align="left">BIL</td>
</tr>
</tbody>
</table>
<p>The spatial resolution of TerraClimate data commensurates 5 km in the
equator, whereas that of PRISM data is approximately 1 km. The data are
available in the NetCDF format which is readable with GDAL. We will use
the <code>terra</code> package to read the data.</p>
<div class="section level3">
<h3 id="prepare-target-datasets">Prepare target datasets<a class="anchor" aria-label="anchor" href="#prepare-target-datasets"></a>
</h3>
<p>We will consider the populated places centroids in the mainland
United States (i.e., excluding Alaska, Hawaii, and the territories). We
will use the <a href="https://cran.r-project.org/web/packages/tigris/index.html" class="external-link"><code>tigris</code></a>
package to download the data.</p>
<table class="table">
<colgroup>
<col width="29%">
<col width="23%">
<col width="23%">
<col width="23%">
</colgroup>
<thead><tr class="header">
<th align="center">Data</th>
<th align="left">Number of features</th>
<th align="left">Source</th>
<th align="left">Type</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">Census places</td>
<td align="left">31,377</td>
<td align="left">US Census Bureau</td>
<td align="left">Polygon</td>
</tr>
<tr class="even">
<td align="center">Block groups</td>
<td align="left">238,193</td>
<td align="left">US Census Bureau</td>
<td align="left">Polygon</td>
</tr>
<tr class="odd">
<td align="center">Grid points in the southeastern US</td>
<td align="left">1,204,904</td>
<td align="left">Author, US Census Bureau (state polygons)</td>
<td align="left">Point</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/chopin">chopin</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/stars/" class="external-link">stars</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org" class="external-link">future</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.mirai.futureverse.org" class="external-link">future.mirai</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://parallelly.futureverse.org" class="external-link">parallelly</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/walkerke/tigris" class="external-link">tigris</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jabiru/tictoc" class="external-link">tictoc</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>tigris_use_cache <span class="op">=</span> <span class="cn">TRUE</span>, sf_use_s2 <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="hardware-specification">Hardware specification<a class="anchor" aria-label="anchor" href="#hardware-specification"></a>
</h3>
<p>We used a machine with 112 physical CPU cores with 750 GB of memory,
but we used only a portion of the cores (up to 20) for the
demonstration. No maximum possible memory usage was set. However, in
typical HPC management systems, users are required to request the number
of cores and memory for their jobs. The number of cores and memory
capacity should be considered when users parallelize the extraction
process.</p>
</div>
<div class="section level3">
<h3 class="tabset" id="download-and-preprocess">Download and preprocess<a class="anchor" aria-label="anchor" href="#download-and-preprocess"></a>
</h3>
<div class="section level4">
<h4 id="download">Download<a class="anchor" aria-label="anchor" href="#download"></a>
</h4>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># populated places</span></span>
<span><span class="va">state</span> <span class="op">&lt;-</span> <span class="fu">tigris</span><span class="fu">::</span><span class="fu">states</span><span class="op">(</span>year <span class="op">=</span> <span class="fl">2022</span><span class="op">)</span></span>
<span><span class="va">statemain</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">state</span><span class="op">[</span><span class="op">!</span><span class="va">state</span><span class="op">$</span><span class="va">STUSPS</span> <span class="op"><a href="https://rspatial.github.io/terra/reference/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"AK"</span>, <span class="st">"HI"</span>, <span class="st">"PR"</span>, <span class="st">"VI"</span>, <span class="st">"GU"</span>, <span class="st">"MP"</span>, <span class="st">"AS"</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="va">target_states</span> <span class="op">&lt;-</span> <span class="va">statemain</span><span class="op">$</span><span class="va">GEOID</span></span>
<span></span>
<span><span class="va">popplace</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">target_states</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">tigris</span><span class="fu">::</span><span class="fu">places</span><span class="op">(</span><span class="va">x</span>, year <span class="op">=</span> <span class="fl">2022</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">.</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/serialize.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">popplace</span>, <span class="st">"./input/populated_place_2022.rds"</span>, compress <span class="op">=</span> <span class="st">"xz"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="read">Read<a class="anchor" aria-label="anchor" href="#read"></a>
</h4>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">state</span> <span class="op">&lt;-</span> <span class="fu">tigris</span><span class="fu">::</span><span class="fu">states</span><span class="op">(</span>year <span class="op">=</span> <span class="fl">2022</span><span class="op">)</span></span>
<span><span class="va">statemain</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">state</span><span class="op">[</span><span class="op">!</span><span class="va">state</span><span class="op">$</span><span class="va">STUSPS</span> <span class="op"><a href="https://rspatial.github.io/terra/reference/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"AK"</span>, <span class="st">"HI"</span>, <span class="st">"PR"</span>, <span class="st">"VI"</span>, <span class="st">"GU"</span>, <span class="st">"MP"</span>, <span class="st">"AS"</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="va">target_states</span> <span class="op">&lt;-</span> <span class="va">statemain</span><span class="op">$</span><span class="va">GEOID</span></span>
<span></span>
<span><span class="co"># download populated places</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>tigris_use_cache <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">popplace</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">target_states</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">tigris</span><span class="fu">::</span><span class="fu">places</span><span class="op">(</span>year <span class="op">=</span> <span class="fl">2022</span>, state <span class="op">=</span> <span class="va">x</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="va">popplace</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">popplace</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># generate circular buffers with 10 km radius</span></span>
<span><span class="va">popplacep</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_centroid</a></span><span class="op">(</span><span class="va">popplace</span>, of_largest_polygon <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="st">"EPSG:5070"</span><span class="op">)</span></span>
<span><span class="va">popplacep2</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_centroid</a></span><span class="op">(</span><span class="va">popplace</span>, of_largest_polygon <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">popplaceb</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_buffer</a></span><span class="op">(</span><span class="va">popplacep</span>, dist <span class="op">=</span> <span class="fu">units</span><span class="fu">::</span><span class="fu"><a href="https://r-quantities.github.io/units/reference/units.html" class="external-link">set_units</a></span><span class="op">(</span><span class="fl">10</span>, <span class="st">"km"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
</div>
<div class="section level2">
<h2 id="terraclimate">TerraClimate<a class="anchor" aria-label="anchor" href="#terraclimate"></a>
</h2>
<p>TerraClimate data are provided in yearly NetCDF files, each of which
contains monthly layers. We will read the data with the <a href="https://cran.r-project.org/web/packages/terra/index.html" class="external-link"><code>terra</code></a>
package and preprocess the data to extract the annual mean and sum of
the bands by types of columns.</p>
<p>For reproducibility, run the code below with our companion package
<code>amadeus</code> to download terraClimate data. Please note that it
will take a while depending on the internet speed.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/is_installed.html" class="external-link">check_installed</a></span><span class="op">(</span><span class="st">"amadeus"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tcli_variables</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"aet"</span>, <span class="st">"def"</span>, <span class="st">"pet"</span>, <span class="st">"ppt"</span>, <span class="st">"q"</span>, <span class="st">"soil"</span>, <span class="st">"swe"</span>,</span>
<span>  <span class="st">"PDSI"</span>, <span class="st">"srad"</span>, <span class="st">"tmax"</span>, <span class="st">"tmin"</span>, <span class="st">"vap"</span>, <span class="st">"vpd"</span>, <span class="st">"ws"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">amadeus</span><span class="fu">::</span><span class="fu">download_terraclimate</span><span class="op">(</span></span>
<span>  variables <span class="op">=</span> <span class="va">tcli_variables</span>,</span>
<span>  year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2000</span>, <span class="fl">2022</span><span class="op">)</span>,</span>
<span>  directory_to_save <span class="op">=</span> <span class="st">"./input/terraClimate"</span>,</span>
<span>  acknowledgement <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  download <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  remove_command <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># wbd</span></span>
<span><span class="va">ext_mainland</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="op">-</span><span class="fl">126</span>, xmax <span class="op">=</span> <span class="op">-</span><span class="fl">64</span>, ymin <span class="op">=</span> <span class="fl">22</span>, ymax <span class="op">=</span> <span class="fl">51</span><span class="op">)</span></span>
<span><span class="va">ext_mainland</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/ext.html" class="external-link">ext</a></span><span class="op">(</span><span class="va">ext_mainland</span><span class="op">)</span></span>
<span></span>
<span><span class="va">path_tc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="st">"input"</span>, <span class="st">"terraClimate"</span><span class="op">)</span></span>
<span><span class="va">path_tc_files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span></span>
<span>  path <span class="op">=</span> <span class="va">path_tc</span>, pattern <span class="op">=</span> <span class="st">"*.nc$"</span>,</span>
<span>  full.names <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span><span class="va">path_tc_files</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt;  [1] "input/terraClimate/TerraClimate_aet_2000.nc" </span></span>
<span><span class="co">#&gt;  [2] "input/terraClimate/TerraClimate_aet_2001.nc"</span></span>
<span><span class="co">#&gt;  [truncated]</span></span>
<span><span class="co">#&gt; [321] "input/terraClimate/TerraClimate_ws_2021.nc"  </span></span>
<span><span class="co">#&gt; [322] "input/terraClimate/TerraClimate_ws_2022.nc"</span></span></code></pre>
<div class="section level3">
<h3 id="preprocessing">Preprocessing<a class="anchor" aria-label="anchor" href="#preprocessing"></a>
</h3>
<p>Fourteen variables are available in TerraClimate data. The table
below is from <a href="https://www.climatologylab.org/terraclimate-variables.html" class="external-link">the
TerraClimate website</a>.</p>
<table class="table">
<thead><tr class="header">
<th align="center">Variable</th>
<th align="left">Description</th>
<th align="left">Units</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">aet</td>
<td align="left">Actual Evapotranspiration, monthly total</td>
<td align="left">mm</td>
</tr>
<tr class="even">
<td align="center">def</td>
<td align="left">Climate Water Deficit, monthly total</td>
<td align="left">mm</td>
</tr>
<tr class="odd">
<td align="center">PDSI</td>
<td align="left">Palmer Drought Severity Index, at end of month</td>
<td align="left">unitless</td>
</tr>
<tr class="even">
<td align="center">pet</td>
<td align="left">Potential evapotranspiration, monthly total</td>
<td align="left">mm</td>
</tr>
<tr class="odd">
<td align="center">ppt</td>
<td align="left">Precipitation, monthly total</td>
<td align="left">mm</td>
</tr>
<tr class="even">
<td align="center">q</td>
<td align="left">Runoff, monthly total</td>
<td align="left">mm</td>
</tr>
<tr class="odd">
<td align="center">soil</td>
<td align="left">Soil Moisture, total column - at end of month</td>
<td align="left">mm</td>
</tr>
<tr class="even">
<td align="center">srad</td>
<td align="left">Downward surface shortwave radiation</td>
<td align="left">W/m<sup>2</sup>
</td>
</tr>
<tr class="odd">
<td align="center">swe</td>
<td align="left">Snow water equivalent - at end of month</td>
<td align="left">mm</td>
</tr>
<tr class="even">
<td align="center">tmax</td>
<td align="left">Max Temperature, average for month</td>
<td align="left">C</td>
</tr>
<tr class="odd">
<td align="center">tmin</td>
<td align="left">Min Temperature, average for month</td>
<td align="left">C</td>
</tr>
<tr class="even">
<td align="center">vap</td>
<td align="left">Vapor pressure, average for month</td>
<td align="left">kPa</td>
</tr>
<tr class="odd">
<td align="center">vpd</td>
<td align="left">Vapor Pressure Deficit, average for month</td>
<td align="left">kpa</td>
</tr>
<tr class="even">
<td align="center">ws</td>
<td align="left">Wind speed, average for month</td>
<td align="left">m/s</td>
</tr>
</tbody>
</table>
<p>The variables can be categorized into two types: those that will be
summed and those that will be averaged.</p>
<ul>
<li>Sum: <code>aet</code>, <code>def</code>, <code>pet</code>,
<code>ppt</code>, <code>q</code>, <code>soil</code>, and
<code>swe</code>.</li>
<li>Mean: <code>PDSI</code>, <code>srad</code>, <code>tmax</code>,
<code>tmin</code>, <code>vap</code>, <code>vpd</code>, and
<code>ws</code>.</li>
</ul>
<p>Following that rationale, we will preprocess the data by summing the
first seven layers and averaging the rest of the layers. The code blocks
below follow “split-apply-combine” strategy. Note that
<code><a href="https://rspatial.github.io/terra/reference/tapp.html" class="external-link">terra::tapp</a></code> aggregates layers by its attributes such as
time or custom indices.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>future.globals <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co"># some bands should be summed</span></span>
<span><span class="va">bandnames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"aet"</span>, <span class="st">"def"</span>, <span class="st">"PDSI"</span>, <span class="st">"pet"</span>, <span class="st">"ppt"</span>, <span class="st">"q"</span>, <span class="st">"soil"</span>, <span class="st">"srad"</span>,</span>
<span>  <span class="st">"swe"</span>, <span class="st">"tmax"</span>, <span class="st">"tmin"</span>, <span class="st">"vap"</span>, <span class="st">"vpd"</span>, <span class="st">"ws"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">bandnames_sorted</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">bandnames</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># single nc file, yearly aggregation by fun value</span></span>
<span><span class="co"># band for summation</span></span>
<span><span class="va">bandnames_sum</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"aet"</span>, <span class="st">"def"</span>, <span class="st">"pet"</span>, <span class="st">"ppt"</span>, <span class="st">"q"</span>, <span class="st">"soil"</span>, <span class="st">"swe"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># band for averaging</span></span>
<span><span class="va">bandnames_avg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"PDSI"</span>, <span class="st">"srad"</span>, <span class="st">"tmax"</span>, <span class="st">"tmin"</span>, <span class="st">"vap"</span>, <span class="st">"vpd"</span>, <span class="st">"ws"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># mean: temporally marginal pixel mean (i.e., monthly -&gt; yearly)</span></span>
<span><span class="co"># sum: temporally marginal pixel sum (i.e., monthly -&gt; yearly)</span></span>
<span><span class="co"># Preprocessed data are stored in</span></span>
<span><span class="fu">tictoc</span><span class="fu">::</span><span class="fu">tic</span><span class="op">(</span><span class="st">"sum: 7 layers"</span><span class="op">)</span></span>
<span><span class="va">netcdf_read_sum</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rspatial.github.io/terra/reference/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">bandnames_sum</span>, <span class="va">bandnames_sum</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"("</span>, <span class="va">x</span>, <span class="st">")"</span><span class="op">)</span>, <span class="va">path_tc_files</span>, value <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/tapp.html" class="external-link">tapp</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">x</span>, win <span class="op">=</span> <span class="va">ext_mainland</span>, snap <span class="op">=</span> <span class="st">"out"</span><span class="op">)</span>, index <span class="op">=</span> <span class="st">"years"</span>, fun <span class="op">=</span> <span class="st">"sum"</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="va">netcdf_read_sum</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce</a></span><span class="op">(</span><span class="va">c</span>, <span class="va">netcdf_read_sum</span><span class="op">)</span></span>
<span><span class="fu">tictoc</span><span class="fu">::</span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; sum: 7 layers: 177.974 sec elapsed</span></span></code></pre>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">netcdf_read_sum</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">bandnames_sum</span>, each <span class="op">=</span> <span class="fl">23</span><span class="op">)</span>, <span class="st">"_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">2000</span><span class="op">:</span><span class="fl">2022</span>, <span class="fl">7</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">netcdf_read_sum</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; class       : SpatRaster </span></span>
<span><span class="co">#&gt; dimensions  : 696, 1488, 161  (nrow, ncol, nlyr)</span></span>
<span><span class="co">#&gt; resolution  : 0.04166667, 0.04166667  (x, y)</span></span>
<span><span class="co">#&gt; extent      : -126, -64, 22, 51  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co">#&gt; coord. ref. : +proj=longlat +ellps=WGS84 +no_defs </span></span>
<span><span class="co">#&gt; source(s)   : memory</span></span>
<span><span class="co">#&gt; names       : aet_2000,  aet_2001,  aet_2002,  aet_2003, ... </span></span>
<span><span class="co">#&gt; min values  :     22.9,      27.3,        11,      30.8, ... </span></span>
<span><span class="co">#&gt; max values  :   1270.9,    1366.6,      1399,    1411.1, ... </span></span>
<span><span class="co">#&gt; time (years):   2000 to 2022</span></span></code></pre>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># tictoc::tic("mean: 7 layers")</span></span>
<span><span class="co"># netcdf_read_mean &lt;-</span></span>
<span><span class="co">#   split(bandnames_avg, bandnames_avg) |&gt;</span></span>
<span><span class="co">#   lapply(function(x) {</span></span>
<span><span class="co">#     grep(paste0("(", x, ")"), path_tc_files, value = TRUE)</span></span>
<span><span class="co">#   }) |&gt;</span></span>
<span><span class="co">#   lapply(function(x) {</span></span>
<span><span class="co">#     terra::tapp(terra::rast(x, win = ext_mainland, snap = "out"), index = "years", fun = "mean")</span></span>
<span><span class="co">#   }) |&gt;</span></span>
<span><span class="co">#   Reduce(f = c, x = _)</span></span>
<span><span class="co"># tictoc::toc()</span></span>
<span></span>
<span><span class="co"># names(netcdf_read_mean) &lt;-</span></span>
<span><span class="co">#   sprintf("%s_%d", rep(bandnames_avg, each = 23), rep(2000:2022, 7))</span></span>
<span><span class="co"># netcdf_read_mean</span></span></code></pre></div>
<blockquote>
<p><span class="math display">\[!WARNING\]</span> Stacking raster data
may take a long time and consume a large amount of memory depending on
users’ area of interest and data resolution. Users need to consider the
memory capacity of the system before stacking rasters.</p>
</blockquote>
<p>We have 14 data elements for 23 years with 12 months each. Below
demonstrates the summary of the data layers that were averaged at
circular buffer polygons with 10 kilometers (10,000 meters) radius. To
leverage multiple cores in your machine, run
<code><a href="https://parallelly.futureverse.org/reference/availableCores.html" class="external-link">future::availableCores()</a></code> to check the number of cores and
set the number of workers in <code><a href="https://future.futureverse.org/reference/plan.html" class="external-link">future::plan</a></code> accordingly.
Typically, there are two logical cores in each physical core in modern
central processing units. The number of workers should be set to up to
the number of physical cores in the machine for optimal performance. The
example below uses <code><a href="https://future.futureverse.org/reference/multicore.html" class="external-link">future::multicore</a></code> which shares the
memory across the workers.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">tic</span><span class="op">(</span><span class="st">"multi threads (grid)"</span><span class="op">)</span></span>
<span><span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="fu">future</span><span class="fu">::</span><span class="va"><a href="https://future.futureverse.org/reference/multicore.html" class="external-link">multicore</a></span>, workers <span class="op">=</span> <span class="fl">8L</span><span class="op">)</span></span>
<span><span class="va">grid_init</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">chopin</span><span class="fu">::</span><span class="fu"><a href="../reference/par_pad_grid.html">par_pad_grid</a></span><span class="op">(</span></span>
<span>    <span class="va">popplacep2</span>,</span>
<span>    mode <span class="op">=</span> <span class="st">"grid"</span>,</span>
<span>    padding <span class="op">=</span> <span class="fl">1e4</span>,</span>
<span>    nx <span class="op">=</span> <span class="fl">4L</span>,</span>
<span>    ny <span class="op">=</span> <span class="fl">2L</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">multi_grid</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">chopin</span><span class="fu">::</span><span class="fu"><a href="../reference/par_grid.html">par_grid</a></span><span class="op">(</span></span>
<span>    grids <span class="op">=</span> <span class="va">grid_init</span>,</span>
<span>    fun_dist <span class="op">=</span> <span class="va">extract_at</span>,</span>
<span>    y <span class="op">=</span> <span class="va">popplacep2</span>,</span>
<span>    x <span class="op">=</span> <span class="va">netcdf_read_sum</span>,</span>
<span>    id <span class="op">=</span> <span class="st">"GEOID"</span>,</span>
<span>    func <span class="op">=</span> <span class="st">"mean"</span>,</span>
<span>    radius <span class="op">=</span> <span class="fl">1e4</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; multi threads (grid): 16.668 sec elapsed</span></span></code></pre>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span></span>
<span>  <span class="va">multi</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"("</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">bandnames_sum</span>, collapse <span class="op">=</span> <span class="st">"|"</span><span class="op">)</span>, <span class="st">")"</span><span class="op">)</span>,</span>
<span>      <span class="va">path_tc_files</span>,</span>
<span>      value <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">chopin</span><span class="fu">::</span><span class="fu"><a href="../reference/par_multirasters.html">par_multirasters</a></span><span class="op">(</span></span>
<span>      filenames <span class="op">=</span> <span class="va">.</span>,</span>
<span>      fun_dist <span class="op">=</span> <span class="va">extract_at</span>,</span>
<span>      y <span class="op">=</span> <span class="va">popplacep2</span>,</span>
<span>      x <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="op">)</span>, <span class="co"># ignored</span></span>
<span>      id <span class="op">=</span> <span class="st">"GEOID"</span>,</span>
<span>      func <span class="op">=</span> <span class="st">"mean"</span>,</span>
<span>      radius <span class="op">=</span> <span class="fl">1e4</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt;     user   system  elapsed </span></span>
<span><span class="co">#&gt; 5377.495  231.654  762.147</span></span></code></pre>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="fu">future</span><span class="fu">::</span><span class="va"><a href="https://future.futureverse.org/reference/sequential.html" class="external-link">sequential</a></span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># single thread</span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="st">"single thread"</span><span class="op">)</span></span>
<span><span class="va">single</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">exactextractr</span><span class="fu">::</span><span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html" class="external-link">exact_extract</a></span><span class="op">(</span></span>
<span>    <span class="va">netcdf_read_sum</span>,</span>
<span>    <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">popplaceb</span><span class="op">)</span>,</span>
<span>    fun <span class="op">=</span> <span class="st">"mean"</span>,</span>
<span>    stack_apply <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    force_df <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    append_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"GEOID"</span><span class="op">)</span>,</span>
<span>    progress <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; single thread: 21.161 sec elapsed</span></span></code></pre>
<blockquote>
<p><span class="math display">\[!CAUTION\]</span> All Windows users and
RStudio users (all platforms) will not be able to use
<code><a href="https://future.futureverse.org/reference/multicore.html" class="external-link">future::multicore</a></code> due to the restriction in
<code>future</code> package. Please <code><a href="https://future.futureverse.org/reference/multisession.html" class="external-link">future::multisession</a></code>
instead and note that this option will runs slower than
<code><a href="https://future.futureverse.org/reference/multicore.html" class="external-link">future::multicore</a></code> case.</p>
</blockquote>
<!--
> \[!NOTE\] This is a note.

> \[!TIP\] This is a tip. (Supported since 14 Nov 2023)

> \[!IMPORTANT\] Crucial information comes here.

> \[!CAUTION\] Negative potential consequences of an action. (Supported since 14 Nov 2023)

> \[!WARNING\] Critical content comes here.

-->
</div>
</div>
<div class="section level2">
<h2 id="prism-dataset">PRISM dataset<a class="anchor" aria-label="anchor" href="#prism-dataset"></a>
</h2>
<p>PRISM data are provided in monthly 30-year normal BIL files. Assuming
that a user wants to summarize 30-year normal precipitation at 10
kilometers circular buffers of the geogrpahic centroids of <a href="https://www2.census.gov/geo/pdfs/maps-data/data/tiger/tgrshp2023/TGRSHP2023_TechDoc_Ch4.pdf" class="external-link">US
Census Places</a> (from p.26), we demonstrate the extraction process
with the <code>chopin</code> package.</p>
<div class="section level3">
<h3 class="tabset" id="download-and-preprocess-1">Download and preprocess<a class="anchor" aria-label="anchor" href="#download-and-preprocess-1"></a>
</h3>
<div class="section level4">
<h4 id="download-1">Download<a class="anchor" aria-label="anchor" href="#download-1"></a>
</h4>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># populated places</span></span>
<span><span class="co"># mainland states</span></span>
<span><span class="va">state</span> <span class="op">&lt;-</span> <span class="fu">tigris</span><span class="fu">::</span><span class="fu">states</span><span class="op">(</span>year <span class="op">=</span> <span class="fl">2022</span><span class="op">)</span></span>
<span><span class="va">statemain</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">state</span><span class="op">[</span><span class="op">!</span><span class="va">state</span><span class="op">$</span><span class="va">STUSPS</span> <span class="op"><a href="https://rspatial.github.io/terra/reference/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"AK"</span>, <span class="st">"HI"</span>, <span class="st">"PR"</span>, <span class="st">"VI"</span>, <span class="st">"GU"</span>, <span class="st">"MP"</span>, <span class="st">"AS"</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="va">target_states</span> <span class="op">&lt;-</span> <span class="va">statemain</span><span class="op">$</span><span class="va">GEOID</span></span>
<span></span>
<span><span class="va">popplace</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">target_states</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">tigris</span><span class="fu">::</span><span class="fu">places</span><span class="op">(</span><span class="va">x</span>, year <span class="op">=</span> <span class="fl">2022</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">.</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/serialize.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">popplace</span>, <span class="st">"./input/populated_place_2022.rds"</span>, compress <span class="op">=</span> <span class="st">"xz"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="read-1">Read<a class="anchor" aria-label="anchor" href="#read-1"></a>
</h4>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bils</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="st">"input"</span>, <span class="st">"bil$"</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">bilssds</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">bils</span><span class="op">[</span><span class="op">-</span><span class="fl">13</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">popplace2</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">popplace</span>, crs <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crs.html" class="external-link">crs</a></span><span class="op">(</span><span class="va">bilssds</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">popplaceb2</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">popplaceb</span>, crs <span class="op">=</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crs.html" class="external-link">crs</a></span><span class="op">(</span><span class="va">bilssds</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<blockquote>
<p><span class="math display">\[!IMPORTANT\]</span>
<code><a href="../reference/par_pad_grid.html">chopin::par_pad_grid</a></code> works the best with point datasets
since each grid will clip the input features when parallelized. Polygon
inputs will result in duplicate values in the output and lead to take
longer to complete.</p>
</blockquote>
</div>
</div>
<div class="section level3">
<h3 id="grid-parallelization">Grid parallelization<a class="anchor" aria-label="anchor" href="#grid-parallelization"></a>
</h3>
<p>In the same vein as the TerraClimate data, we will use the
<code>chopin</code> package to parallelize the extraction process with
grid strategy.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">exgrid</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">chopin</span><span class="fu">::</span><span class="fu"><a href="../reference/par_pad_grid.html">par_pad_grid</a></span><span class="op">(</span></span>
<span>    <span class="va">popplacep2</span>,</span>
<span>    mode <span class="op">=</span> <span class="st">"grid"</span>,</span>
<span>    padding <span class="op">=</span> <span class="fl">1e4</span>,</span>
<span>    nx <span class="op">=</span> <span class="fl">4L</span>,</span>
<span>    ny <span class="op">=</span> <span class="fl">2L</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="fu">future</span><span class="fu">::</span><span class="va"><a href="https://future.futureverse.org/reference/multicore.html" class="external-link">multicore</a></span>, workers <span class="op">=</span> <span class="fl">8L</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span></span>
<span>  <span class="va">exmulti</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu">chopin</span><span class="fu">::</span><span class="fu"><a href="../reference/par_grid.html">par_grid</a></span><span class="op">(</span></span>
<span>      <span class="va">exgrid</span>,</span>
<span>      fun_dist <span class="op">=</span> <span class="va">extract_at</span>,</span>
<span>      y <span class="op">=</span> <span class="va">popplacep2</span>,</span>
<span>      x <span class="op">=</span> <span class="va">bilssds</span>,</span>
<span>      radius <span class="op">=</span> <span class="fu">units</span><span class="fu">::</span><span class="fu"><a href="https://r-quantities.github.io/units/reference/units.html" class="external-link">set_units</a></span><span class="op">(</span><span class="fl">1e4</span>, <span class="st">"meter"</span><span class="op">)</span>,</span>
<span>      id <span class="op">=</span> <span class="st">"GEOID"</span>,</span>
<span>      func <span class="op">=</span> <span class="st">"mean"</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Your input function was successfully run at CGRIDID: 1</span></span>
<span><span class="co">#&gt; Your input function was successfully run at CGRIDID: 2</span></span>
<span><span class="co">#&gt; Your input function was successfully run at CGRIDID: 3</span></span>
<span><span class="co">#&gt; Your input function was successfully run at CGRIDID: 4</span></span>
<span><span class="co">#&gt; Your input function was successfully run at CGRIDID: 5</span></span>
<span><span class="co">#&gt; Your input function was successfully run at CGRIDID: 6</span></span>
<span><span class="co">#&gt; Your input function was successfully run at CGRIDID: 7</span></span>
<span><span class="co">#&gt; Your input function was successfully run at CGRIDID: 8</span></span></code></pre>
<pre><code><span><span class="co">#&gt;    user  system elapsed </span></span>
<span><span class="co">#&gt;  33.090  13.254  14.571</span></span></code></pre>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span></span>
<span>  <span class="va">exsingle</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu">exactextractr</span><span class="fu">::</span><span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html" class="external-link">exact_extract</a></span><span class="op">(</span></span>
<span>      <span class="va">bilssds</span>,</span>
<span>      <span class="va">popplaceb2</span>,</span>
<span>      fun <span class="op">=</span> <span class="st">"mean"</span>,</span>
<span>      stack_apply <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>      force_df <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>      append_cols <span class="op">=</span> <span class="st">"GEOID"</span>,</span>
<span>      max_cells_in_memory <span class="op">=</span> <span class="fl">2.14e9</span>,</span>
<span>      progress <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt;    user  system elapsed </span></span>
<span><span class="co">#&gt;  19.347   1.927  21.716</span></span></code></pre>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="fu">future</span><span class="fu">::</span><span class="va"><a href="https://future.futureverse.org/reference/sequential.html" class="external-link">sequential</a></span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="scaled-up-examples">Scaled up examples<a class="anchor" aria-label="anchor" href="#scaled-up-examples"></a>
</h2>
<div class="section level3">
<h3 id="larger-buffer-sizes">Larger buffer sizes<a class="anchor" aria-label="anchor" href="#larger-buffer-sizes"></a>
</h3>
<p>Examples above showed that the difference between the parallelized
and single-threaded extraction process is not significant. We will
increase the buffer size to 50 kilometers and compare the performance of
the parallelized and single-threaded extraction process.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># make buffers</span></span>
<span><span class="va">popplaceb5</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_buffer</a></span><span class="op">(</span><span class="va">popplacep</span>, dist <span class="op">=</span> <span class="fu">units</span><span class="fu">::</span><span class="fu"><a href="https://r-quantities.github.io/units/reference/units.html" class="external-link">set_units</a></span><span class="op">(</span><span class="fl">50</span>, <span class="st">"km"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crs.html" class="external-link">crs</a></span><span class="op">(</span><span class="va">bilssds</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span></span>
<span>  <span class="va">exsingle5</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu">exactextractr</span><span class="fu">::</span><span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html" class="external-link">exact_extract</a></span><span class="op">(</span></span>
<span>      <span class="va">bilssds</span>,</span>
<span>      <span class="va">popplaceb5</span>,</span>
<span>      fun <span class="op">=</span> <span class="st">"mean"</span>,</span>
<span>      stack_apply <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>      force_df <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>      append_cols <span class="op">=</span> <span class="st">"GEOID"</span>,</span>
<span>      max_cells_in_memory <span class="op">=</span> <span class="fl">2.14e9</span>,</span>
<span>      progress <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt;    user  system elapsed </span></span>
<span><span class="co">#&gt; 140.373   2.302 144.552</span></span></code></pre>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">exgrid5k</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">chopin</span><span class="fu">::</span><span class="fu"><a href="../reference/par_pad_grid.html">par_pad_grid</a></span><span class="op">(</span></span>
<span>    <span class="va">popplacep2</span>,</span>
<span>    mode <span class="op">=</span> <span class="st">"grid"</span>,</span>
<span>    padding <span class="op">=</span> <span class="fl">5e4</span>,</span>
<span>    nx <span class="op">=</span> <span class="fl">4L</span>,</span>
<span>    ny <span class="op">=</span> <span class="fl">2L</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="fu">future</span><span class="fu">::</span><span class="va"><a href="https://future.futureverse.org/reference/multicore.html" class="external-link">multicore</a></span>, workers <span class="op">=</span> <span class="fl">8L</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span></span>
<span>  <span class="va">exmulti5k</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu">chopin</span><span class="fu">::</span><span class="fu"><a href="../reference/par_grid.html">par_grid</a></span><span class="op">(</span></span>
<span>      <span class="va">exgrid5k</span>,</span>
<span>      fun_dist <span class="op">=</span> <span class="va">extract_at</span>,</span>
<span>      y <span class="op">=</span> <span class="va">popplacep2</span>,</span>
<span>      x <span class="op">=</span> <span class="va">bilssds</span>,</span>
<span>      radius <span class="op">=</span> <span class="fl">5e4</span>,</span>
<span>      id <span class="op">=</span> <span class="st">"GEOID"</span>,</span>
<span>      func <span class="op">=</span> <span class="st">"mean"</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Your input function was successfully run at CGRIDID: 1</span></span>
<span><span class="co">#&gt; Your input function was successfully run at CGRIDID: 2</span></span>
<span><span class="co">#&gt; Your input function was successfully run at CGRIDID: 3</span></span>
<span><span class="co">#&gt; Your input function was successfully run at CGRIDID: 4</span></span>
<span><span class="co">#&gt; Your input function was successfully run at CGRIDID: 5</span></span>
<span><span class="co">#&gt; Your input function was successfully run at CGRIDID: 6</span></span>
<span><span class="co">#&gt; Your input function was successfully run at CGRIDID: 7</span></span>
<span><span class="co">#&gt; Your input function was successfully run at CGRIDID: 8</span></span>
<span><span class="co">#&gt;    user  system elapsed </span></span>
<span><span class="co">#&gt; 152.344  11.003  60.409</span></span></code></pre>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="fu">future</span><span class="fu">::</span><span class="va"><a href="https://future.futureverse.org/reference/sequential.html" class="external-link">sequential</a></span><span class="op">)</span></span></code></pre></div>
<blockquote>
<p><span class="math display">\[!NOTE\]</span> The example above used
strings of raster file paths for <code>surf</code> argument in
<code>chopin::extract_at_buffer</code>. <code><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">terra::rast</a></code> at
multiple file paths will return a <code>SpatRaster</code> with multiple
layers <strong>only</strong> if the rasters have the same extent and
resolution.</p>
</blockquote>
</div>
<div class="section level3">
<h3 id="larger-number-of-features">Larger number of features<a class="anchor" aria-label="anchor" href="#larger-number-of-features"></a>
</h3>
<p>This example uses 1,204,934 1-km grid points in the southeastern
United States to summarize seven layers of TerraClimate.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## generate 1km grid points in the southeastern US States</span></span>
<span><span class="va">stt</span> <span class="op">&lt;-</span> <span class="fu">tigris</span><span class="fu">::</span><span class="fu">states</span><span class="op">(</span>year <span class="op">=</span> <span class="fl">2020</span><span class="op">)</span></span>
<span><span class="va">targ_states</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"NC"</span>, <span class="st">"SC"</span>, <span class="st">"GA"</span>, <span class="st">"FL"</span>, <span class="st">"AL"</span>, <span class="st">"MS"</span>, <span class="st">"TN"</span>, <span class="st">"LA"</span>, <span class="st">"AR"</span><span class="op">)</span></span>
<span><span class="va">stt_targ</span> <span class="op">&lt;-</span> <span class="va">stt</span><span class="op">[</span><span class="va">stt</span><span class="op">$</span><span class="va">STUSPS</span> <span class="op"><a href="https://rspatial.github.io/terra/reference/match.html" class="external-link">%in%</a></span> <span class="va">targ_states</span>, <span class="op">]</span></span></code></pre></div>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stt_t</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">stt_targ</span>, <span class="st">"EPSG:5070"</span><span class="op">)</span></span>
<span><span class="va">stt_g</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_sample.html" class="external-link">st_sample</a></span><span class="op">(</span><span class="va">stt_t</span>, type <span class="op">=</span> <span class="st">"regular"</span>, <span class="fl">1204934</span><span class="op">)</span></span>
<span><span class="va">stt_g</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">stt_g</span><span class="op">)</span></span>
<span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">stt_g</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"geometry"</span></span>
<span><span class="va">stt_g</span><span class="op">$</span><span class="va">pid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">stt_g</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stt_gb</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_buffer</a></span><span class="op">(</span><span class="va">stt_g</span>, <span class="fu">units</span><span class="fu">::</span><span class="fu"><a href="https://r-quantities.github.io/units/reference/units.html" class="external-link">set_units</a></span><span class="op">(</span><span class="fl">10</span>, <span class="st">"km"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">single_2m</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">exactextractr</span><span class="fu">::</span><span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html" class="external-link">exact_extract</a></span><span class="op">(</span></span>
<span>    <span class="va">netcdf_read_sum</span>,</span>
<span>    <span class="va">stt_gb</span>,</span>
<span>    fun <span class="op">=</span> <span class="st">"mean"</span>,</span>
<span>    stack_apply <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    force_df <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    max_cells_in_memory <span class="op">=</span> <span class="fl">2.14e9</span>,</span>
<span>    progress <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; 855.908 sec elapsed</span></span></code></pre>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stt_gbg</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">chopin</span><span class="fu">::</span><span class="fu"><a href="../reference/par_pad_grid.html">par_pad_grid</a></span><span class="op">(</span></span>
<span>    <span class="va">stt_g</span>,</span>
<span>    mode <span class="op">=</span> <span class="st">"grid"</span>,</span>
<span>    padding <span class="op">=</span> <span class="fl">5e3</span>,</span>
<span>    nx <span class="op">=</span> <span class="fl">5L</span>,</span>
<span>    ny <span class="op">=</span> <span class="fl">5L</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="fu">future</span><span class="fu">::</span><span class="va"><a href="https://future.futureverse.org/reference/multicore.html" class="external-link">multicore</a></span>, workers <span class="op">=</span> <span class="fl">8L</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span></span>
<span>  <span class="va">stt5k</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu">chopin</span><span class="fu">::</span><span class="fu"><a href="../reference/par_grid.html">par_grid</a></span><span class="op">(</span></span>
<span>      <span class="va">stt_gbg</span>,</span>
<span>      fun_dist <span class="op">=</span> <span class="va">extract_at</span>,</span>
<span>      y <span class="op">=</span> <span class="va">stt_g</span>,</span>
<span>      x <span class="op">=</span> <span class="va">netcdf_read_sum</span>,</span>
<span>      id <span class="op">=</span> <span class="st">"pid"</span>,</span>
<span>      radius <span class="op">=</span> <span class="fl">1e4</span>,</span>
<span>      func <span class="op">=</span> <span class="st">"mean"</span>,</span>
<span>      max_cells <span class="op">=</span> <span class="fl">2e7</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt;   user  system elapsed </span></span>
<span><span class="co">#&gt;  6.745   4.102 434.041</span></span></code></pre>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="fu">future</span><span class="fu">::</span><span class="va"><a href="https://future.futureverse.org/reference/sequential.html" class="external-link">sequential</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 class="tabset" id="finely-resolved-vector">Finely resolved vector<a class="anchor" aria-label="anchor" href="#finely-resolved-vector"></a>
</h3>
<p>Using PRISM data, the example below summarizes the mean values of
each data element at census block groups.</p>
<div class="section level4">
<h4 id="download-2">Download<a class="anchor" aria-label="anchor" href="#download-2"></a>
</h4>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># set state=NULL and cb=TRUE will download the block groups for the entire US</span></span>
<span><span class="va">bg</span> <span class="op">&lt;-</span> <span class="fu">tigris</span><span class="fu">::</span><span class="fu">block_groups</span><span class="op">(</span>state <span class="op">=</span> <span class="cn">NULL</span>, cb <span class="op">=</span> <span class="cn">TRUE</span>, year <span class="op">=</span> <span class="fl">2020</span><span class="op">)</span></span>
<span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_write.html" class="external-link">write_sf</a></span><span class="op">(</span><span class="va">bg</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="st">"input"</span>, <span class="st">"Blockgroups_2020.gpkg"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="extract">Extract<a class="anchor" aria-label="anchor" href="#extract"></a>
</h4>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## extract prism by par_hierarchy</span></span>
<span><span class="va">bgsf</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">st_read</a></span><span class="op">(</span><span class="st">"input/Blockgroups_2020.gpkg"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Reading layer `Blockgroups_2020' from data source </span></span>
<span><span class="co">#&gt;   `/ddn/gs1/home/songi2/projects/chopin/input/Blockgroups_2020.gpkg' </span></span>
<span><span class="co">#&gt;   using driver `GPKG'</span></span>
<span><span class="co">#&gt; Simple feature collection with 242298 features and 11 fields</span></span>
<span><span class="co">#&gt; Geometry type: MULTIPOLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -179.1467 ymin: -14.5487 xmax: 179.7785 ymax: 71.38782</span></span>
<span><span class="co">#&gt; Geodetic CRS:  NAD83</span></span></code></pre>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bgsf_main</span> <span class="op">&lt;-</span> <span class="va">bgsf</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">STATEFP</span> <span class="op"><a href="https://rspatial.github.io/terra/reference/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"02"</span>, <span class="st">"15"</span>, <span class="st">"72"</span>, <span class="st">"66"</span>, <span class="st">"78"</span>, <span class="st">"60"</span>, <span class="st">"69"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## extract prism at bg</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span></span>
<span>  <span class="va">exsingle</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu">exactextractr</span><span class="fu">::</span><span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html" class="external-link">exact_extract</a></span><span class="op">(</span></span>
<span>      <span class="va">bilssds</span>,</span>
<span>      <span class="va">bgsf_main</span>,</span>
<span>      fun <span class="op">=</span> <span class="st">"mean"</span>,</span>
<span>      stack_apply <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>      force_df <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>      append_cols <span class="op">=</span> <span class="st">"GEOID"</span>,</span>
<span>      max_cells_in_memory <span class="op">=</span> <span class="fl">2.14e9</span>,</span>
<span>      progress <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt;    user  system elapsed </span></span>
<span><span class="co">#&gt;  60.387   2.059  64.147</span></span></code></pre>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nmain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"AS"</span>, <span class="st">"AK"</span>, <span class="st">"HI"</span>, <span class="st">"PR"</span>, <span class="st">"VI"</span>, <span class="st">"GU"</span>, <span class="st">"MP"</span><span class="op">)</span></span>
<span><span class="va">stt_nmain</span> <span class="op">&lt;-</span> <span class="va">stt</span><span class="op">[</span><span class="op">!</span><span class="va">stt</span><span class="op">$</span><span class="va">STUSPS</span> <span class="op"><a href="https://rspatial.github.io/terra/reference/match.html" class="external-link">%in%</a></span> <span class="va">nmain</span>, <span class="op">]</span></span>
<span></span>
<span></span>
<span><span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="fu">future.mirai</span><span class="fu">::</span><span class="va"><a href="https://future.mirai.futureverse.org/reference/mirai_multisession.html" class="external-link">mirai_multisession</a></span>, workers <span class="op">=</span> <span class="fl">20L</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span></span>
<span>  <span class="va">exhierarchy</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu">chopin</span><span class="fu">::</span><span class="fu"><a href="../reference/par_hierarchy.html">par_hierarchy</a></span><span class="op">(</span></span>
<span>      <span class="va">bgsf_main</span>,</span>
<span>      regions_id <span class="op">=</span> <span class="st">"STATEFP"</span>,</span>
<span>      fun_dist <span class="op">=</span> <span class="va">extract_at</span>,</span>
<span>      y <span class="op">=</span> <span class="va">bgsf_main</span>,</span>
<span>      x <span class="op">=</span> <span class="va">bilssds</span>,</span>
<span>      id <span class="op">=</span> <span class="st">"GEOID"</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt;    user  system elapsed </span></span>
<span><span class="co">#&gt;   2.205   0.558 158.905</span></span></code></pre>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="fu">future</span><span class="fu">::</span><span class="va"><a href="https://future.futureverse.org/reference/sequential.html" class="external-link">sequential</a></span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="finely-resolved-raster">Finely resolved raster<a class="anchor" aria-label="anchor" href="#finely-resolved-raster"></a>
</h3>
<p>We demonstrate the extraction process with the <a href="https://croplandcros.scinet.usda.gov" class="external-link">CropScape</a> dataset which
has a resolution of 30 meters. In this case, we use <code>frac</code>
option of <code>exact_extract</code> which tabulates the fraction of the
area of the cell category that is covered by the polygon after
accounting for partial coverage of polygon segments over raster
cells.</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cdl</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="st">"input/2022_cdls/2022_30m_cdls.tif"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span></span>
<span>  <span class="va">bgsf_cdl_single</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu">exactextractr</span><span class="fu">::</span><span class="fu"><a href="https://isciences.gitlab.io/exactextractr/reference/exact_extract.html" class="external-link">exact_extract</a></span><span class="op">(</span></span>
<span>      <span class="va">cdl</span>,</span>
<span>      <span class="va">bgsf_main</span>,</span>
<span>      fun <span class="op">=</span> <span class="st">"frac"</span>,</span>
<span>      stack_apply <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>      force_df <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>      append_cols <span class="op">=</span> <span class="st">"GEOID"</span>,</span>
<span>      max_cells_in_memory <span class="op">=</span> <span class="fl">2.14e9</span>,</span>
<span>      progress <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt;     user   system  elapsed </span></span>
<span><span class="co">#&gt; 1013.411   44.322 1369.053</span></span></code></pre>
<p>For balancing computation time, we will split the block groups into
nine subsets to parallelize. Note that
<code>mode = "grid_quantile"</code> is used in <code>par_pad_grid</code>
to balance the number of block groups per grid. When <code>input</code>
argument of <code>par_pad_grid</code> is polygons, a few polygons will
have duplicate rows in the output data.frame since block groups
overlapping each grid will be selected.</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cdl</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="st">"input/2022_cdls/2022_30m_cdls.tif"</span><span class="op">)</span></span>
<span><span class="va">bgsf</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">st_read</a></span><span class="op">(</span><span class="st">"input/Blockgroups_2020.gpkg"</span><span class="op">)</span></span>
<span><span class="va">bgsf_main</span> <span class="op">&lt;-</span> <span class="va">bgsf</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">STATEFP</span> <span class="op"><a href="https://rspatial.github.io/terra/reference/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"02"</span>, <span class="st">"15"</span>, <span class="st">"72"</span>, <span class="st">"66"</span>, <span class="st">"78"</span>, <span class="st">"60"</span>, <span class="st">"69"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># balancing the number of features assigned per workers</span></span>
<span><span class="co"># by splitting block groups by splitting centroids</span></span>
<span><span class="va">bgsf_9grids_plain</span> <span class="op">&lt;-</span> <span class="va">bgsf_main</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">chopin</span><span class="fu">::</span><span class="fu"><a href="../reference/par_pad_grid.html">par_pad_grid</a></span><span class="op">(</span></span>
<span>    mode <span class="op">=</span> <span class="st">"grid"</span>,</span>
<span>    nx <span class="op">=</span> <span class="fl">3L</span>, ny <span class="op">=</span> <span class="fl">3L</span>, padding <span class="op">=</span> <span class="fl">1e4</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">bgsf_9grids</span> <span class="op">&lt;-</span> <span class="va">bgsf_main</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">chopin</span><span class="fu">::</span><span class="fu"><a href="../reference/par_pad_grid.html">par_pad_grid</a></span><span class="op">(</span></span>
<span>    mode <span class="op">=</span> <span class="st">"grid_quantile"</span>,</span>
<span>    padding <span class="op">=</span> <span class="fl">1e4</span>,</span>
<span>    quantiles <span class="op">=</span> <span class="fu">chopin</span><span class="fu">::</span><span class="fu"><a href="../reference/par_def_q.html">par_def_q</a></span><span class="op">(</span><span class="fl">3L</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="fu">future.mirai</span><span class="fu">::</span><span class="va"><a href="https://future.mirai.futureverse.org/reference/mirai_multisession.html" class="external-link">mirai_multisession</a></span>, workers <span class="op">=</span> <span class="fl">9L</span><span class="op">)</span></span>
<span><span class="co"># Note that bgsf_9grids were converted to sf</span></span>
<span><span class="co"># for exporting the objects to the parallel workers</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span></span>
<span>  <span class="va">bgsf_cdl_par</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu">chopin</span><span class="fu">::</span><span class="fu"><a href="../reference/par_grid.html">par_grid</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">bgsf_9grids</span>, <span class="fu">sf</span><span class="fu">::</span><span class="va"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">)</span>,</span>
<span>      fun_dist <span class="op">=</span> <span class="va">extract_at</span>,</span>
<span>      y <span class="op">=</span> <span class="va">bgsf_main</span>,</span>
<span>      x <span class="op">=</span> <span class="va">cdl</span>,</span>
<span>      id <span class="op">=</span> <span class="st">"GEOID"</span>,</span>
<span>      func <span class="op">=</span> <span class="st">"frac"</span>,</span>
<span>      max_cells <span class="op">=</span> <span class="fl">2e7</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Your input function was successfully run at CGRIDID: 1</span></span>
<span><span class="co">#&gt; Your input function was successfully run at CGRIDID: 2</span></span>
<span><span class="co">#&gt; Your input function was successfully run at CGRIDID: 3</span></span>
<span><span class="co">#&gt; Your input function was successfully run at CGRIDID: 4</span></span>
<span><span class="co">#&gt; Your input function was successfully run at CGRIDID: 5</span></span>
<span><span class="co">#&gt; Your input function was successfully run at CGRIDID: 6</span></span>
<span><span class="co">#&gt; Your input function was successfully run at CGRIDID: 7</span></span>
<span><span class="co">#&gt; Your input function was successfully run at CGRIDID: 8</span></span>
<span><span class="co">#&gt; Your input function was successfully run at CGRIDID: 9</span></span>
<span><span class="co">#&gt;   user  system elapsed </span></span>
<span><span class="co">#&gt;  6.632   1.821 347.638</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a>
</h3>
<ul>
<li><a href="https://posit.co/blog/geospatial-distributed-processing-with-furrr/" class="external-link">Garnett,
R. (2023). Geospatial distributed processing with furrr</a></li>
<li><a href="https://kadyb.github.io/stars-parallel/Tutorial.html" class="external-link">Dyba,
K. (n.d.). Parallel raster processing in <em>stars</em></a></li>
</ul>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><!-- begin footer --><div class="footer">
    <div class="container">
        <div class="row start top-4 bottom-8">
            <div class="col-2"> <img id="footerlogo" src="https://ropensci.org/img/icon_short_white.svg">
</div>
            <div class="col-10">
                <div class="row">
                    <div class="col-md-4 col-xs-6">
                        <a href="https://github.com/ropensci" target="_blank" class="external-link"><div class="icon fab fa-github"></div></a>
                        <a href="https://github.com/ropenscilabs" target="_blank" class="external-link"><div class="icon fa fa-flask"></div></a>
                        <a href="https://hachyderm.io/@ropensci" target="_blank" class="external-link"><div class="icon fab fa-mastodon"></div></a>
                        <a href="https://vimeo.com/ropensci" target="_blank" class="external-link"><div class="icon fab fa-vimeo"></div></a>
                    </div>
                </div>
                <div class="row top-4">
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">About</h5>
                            <li><a href="https://ropensci.org/about" class="external-link">About rOpenSci</a></li>
                            <li><a href="https://ropensci.org/software-review" class="external-link">Software Review</a></li>
                            <li><a href="https://ropensci.org/about#team" class="external-link">Our Team</a></li>
                            <li><a href="https://ropensci.org/careers" class="external-link">Jobs</a></li>
                            <li><a href="https://ropensci.org/donate" class="external-link">Donate</a></li>
                            <li><a href="https://ropensci.org/contact" class="external-link">Contact Us</a></li>
                        </ul>
</div>
                    <div class="col-md-3 col-sm-4">
                        <ul>
<h5 class="bottom-2">Community</h5>
                            <li><a href="https://ropensci.org/community/" class="external-link">Our Community</a></li>
                            <li><a href="https://ropensci.org/commcalls/" class="external-link">Community calls</a></li>
                            <li><a href="https://ropensci.org/events/" class="external-link">Events</a></li>
                            <li><a href="https://discuss.ropensci.org/" class="external-link">Join the Discussion</a></li>
                            <li><a href="https://ropensci.org/code-of-conduct" class="external-link">Code of conduct</a></li>
                        </ul>
</div>
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">Resources</h5>
                            <li><a href="https://ropensci.org/packages/" class="external-link">Packages</a></li>
                            <li><a href="https://ropensci.org/usecases/" class="external-link">Use Cases</a></li>
                            <li><a href="https://ropensci.org/talks-papers/" class="external-link">Talks &amp; Publications</a></li>
                            <li><a href="https://docs.ropensci.org/" class="external-link">Documentation</a></li>
                            <li><a href="https://ropensci.org/news/" class="external-link">Newsletter</a></li>
                            <li><a href="https://ropensci.org/how-to-cite-ropensci/" class="external-link">Cite rOpenSci</a></li>
                        </ul>
</div>
                    <div class="col-md-4 col-xs-12">
                        <h5 class="bottom-2"></h5>

                        <p>rOpenSci is a fiscally sponsored project of <a href="http://numfocus.org" class="external-link">NumFOCUS</a>.</p>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- / end footer -->


    </footer>
</div>





  </body>
</html>
